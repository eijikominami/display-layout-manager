name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          # Install Homebrew dependencies
          brew install jakehilborn/jakehilborn/displayplacer
          brew install grep

      - name: Install Python package
        run: |
          pip install -e .

      - name: Install test dependencies
        run: |
          pip install coverage

      - name: Run unit tests
        run: |
          python tests/run_all_tests.py

      - name: Run integration tests
        run: |
          python -m src.display_layout_manager.main --run-tests --verbose

      - name: Generate coverage report
        run: |
          python tests/run_coverage.py

  release:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Extract changelog for this version
          if [ -f CHANGELOG.md ]; then
            # Get changelog section for this version
            CHANGELOG=$(awk '/^## \['"${GITHUB_REF#refs/tags/v}"'\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md || echo "See CHANGELOG.md for details.")
          else
            CHANGELOG="Initial release of Display Layout Manager"
          fi

          # Save changelog to file for multiline output
          cat << 'EOF' > changelog.txt
          ## Changes in ${{ steps.version.outputs.VERSION }}

          ${CHANGELOG}

          ## Installation

          ```bash
          # Install via Homebrew
          brew tap eijikominami/display-layout-manager
          brew install display-layout-manager

          # Or install from source
          pip install git+https://github.com/eijikominami/display-layout-manager.git
          ```

          ## Usage

          ```bash
          # Save current display layout
          display-layout-manager --save-current

          # Apply saved layout automatically
          display-layout-manager

          # Show current displays
          display-layout-manager --show-displays
          ```
          EOF

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Display Layout Manager ${{ steps.version.outputs.VERSION }}
          body_path: changelog.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: [test, release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Get release info
        id: release_info
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          # Calculate SHA256 of the release tarball
          TARBALL_URL="https://github.com/eijikominami/display-layout-manager/archive/${VERSION}.tar.gz"
          SHA256=$(curl -sL "$TARBALL_URL" | sha256sum | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TARBALL_URL=$TARBALL_URL" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: eijikominami/homebrew-display-layout-manager
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update Homebrew Formula
        run: |
          cd homebrew-tap

          # Update the formula
          cat > Formula/display-layout-manager.rb << 'EOF'
          class DisplayLayoutManager < Formula
            include Language::Python::Virtualenv

            desc "macOS用ディスプレイレイアウト自動設定ツール"
            homepage "https://github.com/eijikominami/display-layout-manager"
            url "${{ steps.release_info.outputs.TARBALL_URL }}"
            sha256 "${{ steps.release_info.outputs.SHA256 }}"
            license "MIT"

            depends_on "python@3.11"
            depends_on "jakehilborn/jakehilborn/displayplacer"
            depends_on "grep"

            resource "pyobjc-core" do
              url "https://files.pythonhosted.org/packages/b8/b6/d5612eb40be4fd5ef88c259339e6313f46ba67577a95d86c3470b951fce0/pyobjc_core-12.1.tar.gz"
              sha256 "2bb3903f5387f72422145e1466b3ac3f7f0ef2e9960afa9bcd8961c5cbf8bd21"
            end

            resource "pyobjc-framework-Cocoa" do
              url "https://files.pythonhosted.org/packages/02/a3/16ca9a15e77c061a9250afbae2eae26f2e1579eb8ca9462ae2d2c71e1169/pyobjc_framework_cocoa-12.1.tar.gz"
              sha256 "5556c87db95711b985d5efdaaf01c917ddd41d148b1e52a0c66b1a2e2c5c1640"
            end

            resource "rumps" do
              url "https://files.pythonhosted.org/packages/b2/e2/2e6a47951290bd1a2831dcc50aec4b25d104c0cf00e8b7868cbd29cf3bfe/rumps-0.4.0.tar.gz"
              sha256 "17fb33c21b54b1e25db0d71d1d793dc19dc3c0b7d8c79dc6d833d0cffc8b1596"
            end

            def install
              virtualenv_install_with_resources

              # Manually create menubar entry point if it doesn't exist
              unless (bin/"display-layout-menubar").exist?
                (bin/"display-layout-menubar").write <<~EOS
                  #!/bin/bash
                  exec "#{libexec}/bin/python" -m display_layout_manager.menubar "$@"
                EOS
                chmod 0755, bin/"display-layout-menubar"
              end
            end

            def post_install
              config_dir = "#{Dir.home}/Library/Application Support/DisplayLayoutManager"
              system "mkdir", "-p", config_dir
              system "chmod", "700", config_dir

              log_dir = "#{Dir.home}/Library/Logs/DisplayLayoutManager"
              system "mkdir", "-p", log_dir
              system "chmod", "700", log_dir

              # セットアップ完了メッセージ
              puts <<~EOS
                Display Layout Manager がインストールされました。

                CLI使用方法:
                  display-layout-manager --save-current     # 現在のレイアウトを保存
                  display-layout-manager                    # 保存されたレイアウトを適用
                  display-layout-manager --show-displays   # 接続されたディスプレイを表示

                メニューバーアプリ:
                  display-layout-menubar            # メニューバーアプリを起動
                  display-layout-menubar --enable-auto-launch  # 自動起動を有効化

                設定ファイル:
                  ~/Library/Application Support/DisplayLayoutManager/config.json

                ログファイル:
                  ~/Library/Logs/DisplayLayoutManager/
              EOS
            end

            test do
              assert_match "Display Layout Manager", shell_output("#{bin}/display-layout-manager --version")
              system "#{bin}/display-layout-manager", "--run-tests"
            end
          end
          EOF

          # Commit and push changes
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/display-layout-manager.rb
          git commit -m "Update display-layout-manager to ${{ steps.release_info.outputs.VERSION }}"
          git push

  notify:
    needs: [test, release, update-homebrew]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify success
        if: needs.test.result == 'success' && needs.release.result == 'success' && needs.update-homebrew.result == 'success'
        run: |
          echo "✅ Release ${{ needs.release.outputs.version }} completed successfully!"
          echo "- Tests passed"
          echo "- GitHub Release created"
          echo "- Homebrew Formula updated"

      - name: Notify failure
        if: needs.test.result == 'failure' || needs.release.result == 'failure' || needs.update-homebrew.result == 'failure'
        run: |
          echo "❌ Release ${{ needs.release.outputs.version }} failed!"
          echo "- Test result: ${{ needs.test.result }}"
          echo "- Release result: ${{ needs.release.result }}"
          echo "- Homebrew update result: ${{ needs.update-homebrew.result }}"
          exit 1
